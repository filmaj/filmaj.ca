<h1>Introducing <a href="http://github.com/apache/incubator-cordova-js">Cordova-JS</a></h1>

A lot of exciting things have happened in the past six months or so: my former
employer <a href="http://nitobi.com">Nitobi</a> got acquired by <a href="http://adobe.com">Adobe</a> and our team of about 18 more or less
got split right down the middle. Half are now settling into San Francisco,
while the rest (me included) are holding down the Canadian fort in Vancouver
and doing our best to represent <a href="http://adobe.com">Adobe</a> up in the Great White North.</p>

<p>I'm still working on <a href="http://phonegap.com">PhoneGap</a>, now reborn as an <a href="http://apache.org">Apache Software Foundation</a>
project known as <a href="http://incubator.apache.org/cordova">Cordova</a>. My most recent task has involved bringing the
disparate implementations of <a href="http://incubator.apache.org/cordova">Cordova</a>'s <a href="http://docs.phonegap.com">JavaScript API</a> - a consistent,
cross-platform API - under one repository. Up until this point, each platform
maintained its own set of JavaScript files implementing this API. The
idea and implementation I'm going to present in this post is that 90+ percent of the
JavaScript for any given <a href="http://incubator.apache.org/cordova">Cordova</a> platform is identical. Most of the <a href="http://incubator.apache.org/cordova">Cordova</a>
API boils down to sending simple messages to the native framework,
with the expectation that a failure or success callback will be fired in the
future back in <a href="http://incubator.apache.org/cordova">Cordova</a>'s web context. The unified JavaScript project is called <a href="http://github.com/apache/incubator-cordova-js">cordova-js</a>.</p>

<p>I'm excited to say that in <a href="http://incubator.apache.org/cordova">Cordova</a> 1.5 we landed <a href="http://github.com/apache/incubator-cordova-js">cordova-js</a> in the <a href="http://github.com/apache/incubator-cordova-android">Android implementation</a>. In
<a href="http://incubator.apache.org/cordova">Cordova</a> 1.6 we are going to drop it into the <a href="http://github.com/apache/incubator-cordova-ios">iOS implementation</a>! It has already
landed in the Apache <a href="http://incubator.apache.org/cordova">Cordova</a> <a href="http://git-wip-us.apache.org/repos/asf?p=incubator-cordova-ios.git;a=commit;h=ab2afceeffda5c5bef9410d1f60b45426176f171">iOS master</a>!</p>

<p>The project
has been an up-and-down ride. <a href="http://twitter.com/davejohnson">Dave Johnson</a> and <a href="http://twitter.com/mwbrooks">Michael Brooks</a> of <a href="http://nitobi.com">Nitobi</a> initially
championed this idea with the <a href="https://github.com/davejohnson/phonegap-js">phonegap-js</a> project. Months later, <a href="http://twitter.com/gordtanner">Gord Tanner</a> from <a href="http://rim.com">RIM</a>
(along some <a href="https://raw.github.com/apache/incubator-cordova-js/master/build/dalek">daleks</a>) was using the same direction <a href="https://github.com/davejohnson/phonegap-js">phonegap-js</a> laid down
to integrate new APIs in their open source device and API emulation tool, <a href="http://ripple.tinyhippos.com/">Ripple</a>.
<a href="http://twitter.com/gordtanner">Gord</a> and company (mostly the old <a href="http://tinyhippos.com">TinyHippos</a> crew, which got acquired by <a href="http://rim.com">RIM</a>)
reached out to us to show us what they did. What we saw blew our minds: clean,
modular syntax for all API definitions with a very clear architecture and obvious
mappings to JavaScript properties and globals. Around this time I jumped in to help
out where I could and <a href="http://twitter.com/gordtanner">Gord</a>, <a href="http://twitter.com/ken_wallis">Ken Wallis</a> and <a href="http://twitter.com/ldhasson">Laurent Hasson</a> from <a href="http://rim.com">RIM</a> all flew up
to Vancouver so that we could discuss the <a href="http://github.com/apache/incubator-cordova-js">cordova-js</a> implementation and hack on it for a
few days (and maybe drink a few beers while we're at it). Turned out to be a
very fruitful week with lots of progress made. One of the early contention
points of the project was: how are we going to implement the module system?
Should we use an existing solution out there or roll our own? Luckily for us
peeps in Vancouver, <a href="http://mozilla.org">Mozilla</a> has an <a href="http://twitter.com/mozillayvr">office and a team up here</a>, and among the
talented people working there is <a href="http://twitter.com/jrburke">James Burke</a>, author of <a href="http://requirejs.org">require.js</a>. Who better
to talk to about the situation than a man closely involved and directly influencing
the various styles of JavaScript modules floating around? We ran a little lunch-
n-learn and invited <a href="http://twitter.com/jrburke">James</a> over to come share ideas. Initially we ended up using
<a href="http://github.com/jrburke/almond">almond.js</a>, a small module loader that was compatible with both <a href="https://github.com/amdjs/amdjs-api/wiki/AMD">AMD</a> and <a href="http://commonjs.org">CommonJS</a>
modules. Later on, to enforce our own requirements (specifically around throwing
exceptions for non-existent modules), we forked and cut down <a href="http://github.com/jrburke/almond">almond.js</a> to the
bare-bones that we need for <a href="http://github.com/apache/incubator-cordova-js">cordova-js</a> purposes. Finally we were on track to
to ship a working version of <a href="http://github.com/apache/incubator-cordova-js">cordova-js</a>. Android was our first target.
<a href="http://twitter.com/infil00p">Joe Bowser</a> (of <a href="http://adobe.com">Adobe</a>/<a href="http://nitobi.com">Nitobi</a>) and <a href="http://twitter.com/macdonst">Simon MacDonald</a> (of <a href="http://ibm.com">IBM</a>) helped make that happen. <a href="http://twitter.com/becka11y">Becky Gibson</a> (of <a href="http://ibm.com">IBM</a>)
and <a href="http://twitter.com/shazron">Shazron Abdullah</a> (<a href="http://adobe.com">Adobe</a>/<a href="http://nitobi.com">Nitobi</a>) put a lot of work in to get it going on iOS. <a href="http://twitter.com/pmuellr">Patrick
  Mueller</a> (<a href="http://ibm.com">IBM</a>), <a href="http://twitter.com/brianleroux">Brian LeRoux</a> (<a href="http://adobe.com">Adobe</a>/<a href="http://nitobi.com">Nitobi</a>) and <a href="http://twitter.com/purplecabbage">Jesse MacFadyen</a> (<a href="http://adobe.com">Adobe</a>/<a href="http://nitobi.com">Nitobi</a>) chimed in to offer advice and guidance. Truly a team and community
effort across corporations (warms my heart!). Thanks to everyone involved for making it happen. This lays down the foundation for us
to hit our goals for <a href="http://incubator.apache.org/cordova">Cordova</a> 2.0.</p>

<h2>Why?</h2>

<p>If it works, why f*** with it? The answer lies in the road ahead to <a href="http://incubator.apache.org/cordova">Cordova</a>
2.0. We want any arbitrary device APIs - be they <a href="http://incubator.apache.org/cordova">Cordova</a> "core" APIs or not -
to be installable, discoverable and removable at a developer's discretion. For
those familiar with <a href="http://phonegap.com">PhoneGap</a> <a href="http://github.com/phonegap/phonegap-plugins">plugins</a>, this is exactly the same idea. A stock
<a href="http://incubator.apache.org/cordova">Cordova</a> API is no different from a plugin. We've been part of the way there for
some time now; all of the various native implementations employ some manner of
plugin architecture. The JavaScript, however, has been a wild-west of sorts. We
are changing that with the introduction of <a href="http://github.com/apache/incubator-cordova-js">cordova-js</a>.</p>

<p>The biggest change is the use of modules in JavaScript. <a href="http://commonjs.org">CommonJS</a>-inspired but
much simpler, it does the job for now. A <a href="https://github.com/apache/incubator-cordova-js/blob/master/lib/require.js">simple <code>define</code> and <code>require</code> syntax</a> is used
and scoped only to the cordova.js file. Within the cordova.js file you'll see things like: </p>

<pre>
<code>
  define('cordova/channel', function() {
    // Amazing code goes here
  });

  // ... somewhere else in the code

  var channel = require('cordova/channel');
  channel.onDeviceReady.fire();
</code>
</pre>

<p>All of the little interesting bits inside the cordova.js file are wrapped in a
<code>define</code> call, turning cordova.js into a set of small, focused modules
tasked with doing one thing well. Early on we scoped our module syntax globally.
<a href="https://issues.apache.org/jira/browse/CB-304">This turned out to be a bad idea</a>. Now, <code>define</code> and <code>require</code> are
available inside the cordova.js file, or if you want to use it for your own projects
you can access these methods via <code>cordova.define</code> or <code>cordova.require</code>.</p>

<p>A side effect of using a <a href="http://commonjs.org">CommonJS</a>-inspired module syntax is that we can use the
resulting script file interchangeably between <a href="http://nodejs.org">node</a> and <a href="http://phonegap.com">PhoneGap</a>/<a href="http://incubator.apache.org/cordova">Cordova</a> contexts. Due to our simple
module system for use in WebView contexts, we can maintain the convention of
one-closure-per-file employed in other <a href="http://commonjs.org">CommonJS</a> environments, or piggy-back off
of <a href="http://nodejs.org">node</a>'s module system to do cool things such as run unit tests locally in
<a href="http://nodejs.org">node</a>. Winning!</p>

<p>As for changes introduced with <a href="http://github.com/apache/incubator-cordova-js">cordova-js</a>, the main one is the name switch in your JS
from <code><a href="http://phonegap.com">PhoneGap</a></code> to <code>cordova</code>.</p>

<p>Next up I'll be aiming to explain a general process for upgrading pre-1.5 plugins
to this new approach (perhaps a case study / real world plugin upgrade to go along with it?).</p>

<p>Happy coding!</p>
